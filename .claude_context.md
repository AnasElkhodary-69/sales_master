# Claude AI Context - Sales Master Project

**Last Updated:** October 15, 2025
**Project:** Sales Master (Multi-tenant Email Campaign Platform)
**Repository:** https://github.com/AnasElkhodary-69/sales_master.git

---

## 🎯 QUICK START FOR NEW SESSIONS

This is a Flask-based SaaS email campaign management platform that has recently been refactored from a "breach-based" system to an "industry-based" targeting system with multi-tenant client management.

### Recent Major Implementation (Oct 2025)
**Client Management System** - A complete multi-tenant architecture was just implemented. Read `CLIENT_MANAGEMENT_SYSTEM_README.md` for full details.

---

## 🏗️ PROJECT ARCHITECTURE

### Technology Stack
- **Backend:** Flask (Python)
- **Database:** SQLite (SQLAlchemy ORM)
- **Frontend:** Bootstrap 5, jQuery, Jinja2 templates
- **Email Provider:** Brevo (formerly SendinBlue)
- **Background Jobs:** APScheduler for auto-enrollment and email processing

### Application Structure
```
Sales Master/
├── app.py                          # Application factory (Flask app creation)
├── models/
│   ├── database.py                 # All SQLAlchemy models
│   └── contact.py                  # Contact model helpers
├── routes/
│   ├── auth.py                     # Authentication routes
│   ├── dashboard.py                # Main dashboard
│   ├── campaigns.py                # Campaign management
│   ├── contacts.py                 # Contact management
│   ├── clients.py                  # ⭐ NEW: Client management (multi-tenant)
│   ├── templates.py                # Email template management
│   ├── sequences.py                # Email sequence management
│   ├── analytics.py                # Analytics routes
│   ├── tracking.py                 # Email tracking (opens, clicks)
│   ├── api.py                      # REST API endpoints
│   ├── webhooks.py                 # Webhook handlers (Brevo)
│   ├── email_trigger.py            # Manual email trigger
│   └── enhanced_analytics.py       # Advanced analytics
├── services/
│   ├── auto_enrollment.py          # Auto-enroll contacts into campaigns
│   ├── brevo_modern_service.py     # Brevo API integration
│   ├── campaign_analytics.py       # Campaign metrics
│   ├── email_processor.py          # Email sending queue processor
│   ├── email_sequence_service.py   # Sequence management logic
│   ├── reply_detection_service.py  # Email reply detection
│   ├── scheduler.py                # Background job scheduler
│   └── template_routes.py          # Template-related service routes
├── templates/
│   ├── base.html                   # Base template (navigation, layout)
│   ├── dashboard.html              # Main dashboard
│   ├── campaigns/                  # Campaign templates
│   ├── contacts/                   # Contact templates
│   ├── clients/                    # ⭐ NEW: Client management templates
│   ├── sequences/                  # Sequence editor templates
│   └── analytics/                  # Analytics templates
├── static/
│   ├── css/style.css               # Main stylesheet
│   └── js/main.js                  # Main JavaScript (includes utilities)
└── data/
    └── app.db                      # SQLite database
```

---

## 🗄️ DATABASE MODELS (Critical to Understand)

### Core Models (in `models/database.py`)

1. **Client** (lines 453-520) - ⭐ NEW
   - Multi-tenant client/customer management
   - Each client has their own sender configuration
   - Tracks email usage quotas
   - Foreign key: campaigns.client_id → clients.id

2. **Campaign**
   - Email campaigns linked to clients
   - Has: name, description, status, target_industry
   - Relationships: contacts (many-to-many), client (many-to-one)

3. **Contact**
   - Target recipients with email, name, company, industry
   - Can belong to multiple campaigns

4. **EmailTemplate**
   - Reusable email templates
   - Supports Jinja2 variables: {{first_name}}, {{company_name}}, etc.

5. **EmailSequence & SequenceStep**
   - Multi-step email sequences
   - Steps have delays, templates, and conditions

6. **Email**
   - Individual email records
   - Tracks: sent_at, opened_at, clicked_at, replied_at
   - Links to: campaign, contact, template

7. **WebhookEvent**
   - Stores Brevo webhook events for tracking

### Relationships You Must Know
- Campaign ← many-to-many → Contact (via contact_campaigns join table)
- Campaign → many Emails
- Client → many Campaigns (via client_id FK)
- EmailSequence → many SequenceSteps
- Contact → many Emails

---

## 🚀 CRITICAL IMPLEMENTATION PATTERNS

### 1. Flask Blueprint Registration Pattern
**Location:** `app.py` lines 83-98

ALL blueprints must be:
1. Imported at top of app.py (lines 16-29)
2. Registered in create_app() function (lines 83-98)

```python
from routes.clients import clients_bp
...
app.register_blueprint(clients_bp)  # /clients/*
```

### 2. Template Inheritance
**Base template:** `templates/base.html`

All templates extend base:
```jinja2
{% extends "base.html" %}
{% block title %}Page Title{% endblock %}
{% block content %}
  <!-- Your content -->
{% endblock %}
{% block extra_js %}
  <!-- Page-specific JavaScript -->
{% endblock %}
```

### 3. Modern UI/UX Requirements
**IMPORTANT:** User prefers modern Bootstrap UI, NO old JavaScript alerts!

✅ **DO:** Use Bootstrap modals for confirmations
✅ **DO:** Use `SalesMaster.utils.showAlert()` for notifications
❌ **DON'T:** Use `alert()` or `confirm()` - user explicitly asked to remove these

Example notification:
```javascript
SalesMaster.utils.showAlert('Success message!', 'success'); // green
SalesMaster.utils.showAlert('Error message!', 'danger');    // red
```

### 4. Database Migration Pattern
When adding new models or columns:
1. Modify `models/database.py`
2. Create a migration script (see `migrate_existing_db.py` as example)
3. Run migration on existing databases
4. New installs auto-create via `db.create_all()`

---

## ⚠️ KNOWN ISSUES & SOLUTIONS

### Issue 1: Flask Template Cache Not Refreshing
**Symptom:** Template changes don't appear even after browser refresh
**Cause:** Flask's Jinja2 template cache doesn't always auto-refresh
**Solution:** Kill all Python processes and restart Flask
```bash
taskkill //F //IM python.exe
python app.py
```

### Issue 2: 404 on Routes After Adding Blueprint
**Symptoms:**
- Route shows in `list_routes.py` but returns 404
- Multiple Flask processes running
**Solution:**
1. Kill ALL Python processes: `taskkill //F //IM python.exe`
2. Clear Python cache: `rm -rf **/__pycache__`
3. Restart Flask once
4. Verify only one Flask process running

### Issue 3: Database Column Doesn't Exist
**Symptom:** "no such column: campaigns.client_id"
**Cause:** Database not migrated after model changes
**Solution:** Run `python migrate_existing_db.py`

---

## 🔑 IMPORTANT CODE LOCATIONS

### Authentication
- Admin credentials: Environment variables `ADMIN_USERNAME` and `ADMIN_PASSWORD`
- Default: admin / SalesBreachPro2025!
- Auth routes: `routes/auth.py`

### Navigation Menu
- **File:** `templates/base.html` lines 60-120
- Structure: Dashboard | Campaigns | Contacts | **Clients** ⭐ | Templates | Analytics
- To add new link: Insert between existing nav items (lines 88-94 for Clients example)

### Email Sending
- **Service:** `services/brevo_modern_service.py`
- Uses Brevo API for transactional emails
- Requires: BREVO_API_KEY in environment

### Background Scheduler
- **File:** `services/scheduler.py`
- Runs every 5 minutes
- Tasks: auto_enrollment, email_processor
- Started in `app.py` lines 142-148

### Jinja2 Variables for Templates
Available in email templates:
- `{{first_name}}` - Contact's first name
- `{{last_name}}` - Contact's last name
- `{{company_name}}` - Contact's company
- `{{industry}}` - Contact's industry
- `{{tracking_pixel}}` - Auto-injected for open tracking
- Custom variables can be added per campaign

---

## 📋 USER PREFERENCES & CONVENTIONS

### Code Style
- **Naming:** snake_case for Python, camelCase for JavaScript
- **Imports:** Group by: stdlib, third-party, local
- **Docstrings:** Use for all functions (triple quotes)

### Git Commit Messages
User prefers comprehensive commits with:
1. Clear title (50 chars)
2. Detailed description
3. Bullet points for features/changes
4. Footer with: "🤖 Generated with [Claude Code]" and "Co-Authored-By: Claude <noreply@anthropic.com>"

### UI/UX Preferences
- Bootstrap 5 components
- Modern modals instead of alerts
- Color-coded buttons (success=green, danger=red, warning=yellow)
- Responsive design (mobile-first)
- Icons from Font Awesome
- Stats cards for dashboards

---

## 🎨 BRANDING & NAMING

### Application Name Evolution
1. **Original:** SalesBreachPro (breach-focused)
2. **Current:** Sales Master (industry-focused)
3. **References:** Still some "breach" references in code comments - being gradually cleaned up

### Industry Targeting
The system targets contacts by industry:
- Technology
- Healthcare
- Finance
- Retail
- Manufacturing
- Education
- Real Estate
- Legal
- (Others as defined in Contact.INDUSTRIES)

---

## 🔧 DEVELOPMENT WORKFLOW

### Starting Flask
```bash
cd "C:\Anas's PC\Moaz\Sales Master"
python app.py
# Runs on http://localhost:5001
```

### Testing Routes
```bash
# List all routes
python list_routes.py

# Test route with curl
curl -s "http://localhost:5001/clients/"
```

### Database Inspection
```bash
# SQLite CLI
sqlite3 "data/app.db"
> .tables
> .schema clients
> SELECT * FROM clients;
```

### Debugging Routes
If routes aren't working:
1. Check `app.py` - blueprint imported and registered?
2. Run `list_routes.py` - does route appear?
3. Curl the route - what error?
4. Check Flask logs for errors
5. Kill all Python and restart

---

## 🚦 CURRENT STATUS (As of Oct 15, 2025)

### ✅ Completed
- [x] Full Client Management System (CRUD)
- [x] Client list page with stats
- [x] Client detail page with campaigns
- [x] Modern Bootstrap modals (no JS alerts)
- [x] Client → Campaign relationship (client_id FK)
- [x] Navigation menu updated
- [x] Database migration script
- [x] All code committed to git (commits: 694b929, a6314d4)

### 🔄 Pending (From TODO List)
- [ ] Update `new_campaign.html` with client selector dropdown
- [ ] Update `routes/campaigns.py` to auto-populate sender info from selected client

### 💡 Future Enhancements (Not Started)
- Multi-user authentication (currently single admin)
- Client API keys for self-service
- Advanced email analytics (heat maps, device tracking)
- A/B testing for email templates
- Scheduled campaign sends

---

## 🧪 TESTING STRATEGY

### Manual Testing Checklist
When making changes to clients or campaigns:
1. Create a client via UI
2. Edit client details
3. View client detail page
4. Create campaign linked to client
5. Verify sender info populated from client
6. Toggle client status
7. Check campaign still works with inactive client
8. Delete client (should warn about campaigns)

### API Testing
```bash
# Test client API
curl http://localhost:5001/clients/api/list
curl http://localhost:5001/clients/api/1
curl http://localhost:5001/clients/api/stats
```

---

## 📞 COMMON USER REQUESTS

### "Add a new feature to Clients page"
1. Read current Clients implementation: `routes/clients.py`
2. Check templates: `templates/clients/list.html`
3. Follow existing patterns (modals for confirms, Bootstrap alerts)
4. Test thoroughly
5. Commit with descriptive message

### "Fix a bug in campaign creation"
1. Read `routes/campaigns.py`
2. Check form in `templates/new_campaign.html`
3. Test the exact flow user described
4. Fix and verify
5. Update any related documentation

### "Add client selector to campaign form"
This is a pending task! Implementation should:
1. Add dropdown in `templates/new_campaign.html`
2. Fetch clients via AJAX or pass in render
3. When client selected, auto-fill sender fields
4. Store client_id when creating campaign
5. Update `routes/campaigns.py` to handle client_id

---

## 🎓 KEY LEARNING FROM THIS SESSION

### Template Cache Issue Was Critical
The biggest debugging challenge was template changes not appearing. Remember:
- Browser cache is different from Flask template cache
- Even incognito mode didn't help
- Only restarting Flask cleared it
- Always curl to verify what Flask is actually serving

### Multiple Flask Processes Cause 404s
At one point, 16 Flask processes were running simultaneously!
- This caused route conflicts
- Some routes worked, some didn't
- Solution: Kill all Python processes before starting

### User Hates Old-School Alerts
User explicitly said "there's javascript alert old notification"
- Replaced all `alert()` with Bootstrap alerts
- Replaced all `confirm()` with Bootstrap modals
- Modern UI is a priority

---

## 📚 REFERENCE FILES

**Read these in future sessions:**
- `CLIENT_MANAGEMENT_SYSTEM_README.md` - Client system documentation
- `app.py` - Application factory and blueprint registration
- `models/database.py` - All database models
- `templates/base.html` - Navigation and layout structure
- `static/js/main.js` - Utility functions (showAlert, etc.)

---

## 🤖 WORKING WITH THIS USER

### Communication Style
- Direct and technical
- Appreciates detailed explanations
- Prefers seeing actual code over descriptions
- Will test immediately and report issues

### Expectations
- Modern, clean UI
- Well-documented code
- Comprehensive git commits
- Solutions that "just work"
- No need to ask permission for obvious improvements

### Workflow
1. User describes what they want
2. I implement it completely
3. User tests it
4. If issues, they report specifically
5. I fix and verify
6. Commit to git when approved

---

## 🎯 NEXT TIME YOU (CLAUDE) READ THIS

1. **Skim this entire document first** (5 min read)
2. **Check git log** to see what's changed since Oct 15, 2025
3. **Read the TODO list** for pending tasks
4. **Ask user what they want to work on**
5. **Reference this doc** for patterns and conventions

**Remember:** This user values efficiency. Don't re-explain things documented here. Jump straight to implementation using the patterns defined above.

---

**End of Claude Context File**
*This file is for AI assistants. For human documentation, see CLIENT_MANAGEMENT_SYSTEM_README.md*
