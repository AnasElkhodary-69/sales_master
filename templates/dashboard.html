{% extends "base.html" %}

{% block title %}Dashboard - SalesBreachPro{% endblock %}

{% block extra_head %}
<style>
    /* Dashboard-specific animations and effects */
    .metric-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .action-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    /* Welcome section styling */
    .welcome-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
    }
    
    /* Clickable card hover effects */
    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
        cursor: pointer;
    }
    
    .clickable-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    Welcome to SalesBreachPro
                </h1>
                <p class="text-muted mb-0">Monitor your email campaigns and track performance in real-time</p>
            </div>
            <div class="text-end">
                <div class="d-flex align-items-center gap-3">
                    <span class="badge fs-6 px-3 py-2" style="background: linear-gradient(135deg, #11998e 0%, #146c43 100%) !important; color: white !important; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3) !important;">
                        <i class="fas fa-chart-line me-1"></i>
                        {{ stats.response_rate }}% Response Rate
                    </span>
                    <div class="text-muted small">
                        <i class="fas fa-clock me-1"></i>
                        Last updated: <span id="last-updated">Just now</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/analytics/emails-week" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-envelope me-2"></i>
                            <h6 class="mb-0 fw-light">Emails This Week</h6>
                        </div>
                        <h2 class="mb-1 fw-bold emails-count">{{ stats.emails_this_week or 0 }}</h2>
                        <small class="opacity-75">
                            {% if stats.emails_this_week > 0 %}
                            <i class="fas fa-arrow-up me-1"></i>Active sending
                            {% else %}
                            <i class="fas fa-pause me-1"></i>Ready to start
                            {% endif %}
                        </small>
                    </div>
                    <div class="opacity-20">
                        <i class="fas fa-paper-plane fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-white-50">
                <small><i class="fas fa-chart-line me-1"></i>Click to view details</small>
            </div>
        </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts/emails/replied" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-reply me-2"></i>
                            <h6 class="mb-0 fw-light">Responses</h6>
                        </div>
                        <h2 class="mb-1 fw-bold responses-count">{{ stats.responses_this_week or 0 }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-percentage me-1"></i><span class="response-rate">{{ stats.response_rate }}</span>% rate
                        </small>
                    </div>
                    <div class="opacity-20">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-white-50">
                <small><i class="fas fa-target me-1"></i>Click to view details</small>
            </div>
        </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-users me-2"></i>
                            <h6 class="mb-0 fw-light">Total Contacts</h6>
                        </div>
                        <h2 class="mb-1 fw-bold contacts-count">{{ stats.total_contacts or 0 }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-database me-1"></i>In database
                        </small>
                    </div>
                    <div class="opacity-20">
                        <i class="fas fa-address-book fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-white-50">
                <small><i class="fas fa-list me-1"></i>Click to view all contacts</small>
            </div>
        </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts/leads?status=hot" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-fire me-2"></i>
                            <h6 class="mb-0 fw-light">Hot Leads</h6>
                        </div>
                        <h2 class="mb-1 fw-bold leads-count">{{ stats.hot_leads or 0 }}</h2>
                        <small class="opacity-75">
                            {% if stats.hot_leads > 0 %}
                            <i class="fas fa-bell me-1"></i>Need attention
                            {% else %}
                            <i class="fas fa-search me-1"></i>Identifying leads
                            {% endif %}
                        </small>
                    </div>
                    <div class="opacity-20">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-white-50">
                <small><i class="fas fa-rocket me-1"></i>Click to view hot leads</small>
            </div>
        </div>
        </a>
    </div>
</div>

<!-- Email Delivery Metrics -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts/emails/delivered" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle me-2"></i>
                                <h6 class="mb-0 fw-light">Delivered</h6>
                            </div>
                            <h2 class="mb-1 fw-bold">{{ stats.delivered_count or 0 }}</h2>
                            <small class="opacity-75">
                                {% if stats.delivered_count > 0 %}
                                <i class="fas fa-percentage me-1"></i>{{ stats.delivery_rate or 0 }}% rate
                                {% else %}
                                <i class="fas fa-inbox me-1"></i>No deliveries yet
                                {% endif %}
                            </small>
                        </div>
                        <div class="opacity-20">
                            <i class="fas fa-inbox fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 text-white-50">
                    <small><i class="fas fa-truck me-1"></i>Click to view details</small>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts/emails/opened" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); box-shadow: 0 10px 30px rgba(96, 165, 250, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-envelope-open me-2"></i>
                                <h6 class="mb-0 fw-light">Opened</h6>
                            </div>
                            <h2 class="mb-1 fw-bold">{{ stats.opened_count or 0 }}</h2>
                            <small class="opacity-75">
                                {% if stats.opened_count > 0 %}
                                <i class="fas fa-percentage me-1"></i>{{ stats.open_rate or 0 }}% rate
                                {% else %}
                                <i class="fas fa-eye-slash me-1"></i>No opens yet
                                {% endif %}
                            </small>
                        </div>
                        <div class="opacity-20">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 text-white-50">
                    <small><i class="fas fa-chart-bar me-1"></i>Click to view details</small>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/contacts/emails/bounced" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <h6 class="mb-0 fw-light">Bounced</h6>
                            </div>
                            <h2 class="mb-1 fw-bold">{{ stats.bounced_count or 0 }}</h2>
                            <small class="opacity-75">
                                {% if stats.bounced_count > 0 %}
                                <i class="fas fa-percentage me-1"></i>{{ stats.bounce_rate or 0 }}% rate
                                {% else %}
                                <i class="fas fa-shield-alt me-1"></i>Clean delivery
                                {% endif %}
                            </small>
                        </div>
                        <div class="opacity-20">
                            <i class="fas fa-ban fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 text-white-50">
                    <small><i class="fas fa-exclamation me-1"></i>Click to view details</small>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="/campaigns?status=active" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-rocket me-2"></i>
                            <h6 class="mb-0 fw-light">Active Campaigns</h6>
                        </div>
                        <h2 class="mb-1 fw-bold">{{ stats.active_campaigns or 0 }}</h2>
                        <small class="opacity-75">
                            {% if stats.active_campaigns > 0 %}
                            <i class="fas fa-play me-1"></i>Running now
                            {% else %}
                            <i class="fas fa-plus me-1"></i>Ready to start
                            {% endif %}
                        </small>
                    </div>
                    <div class="opacity-20">
                        <i class="fas fa-bullhorn fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-white-50">
                <small><i class="fas fa-tasks me-1"></i>Click to view active campaigns</small>
            </div>
        </div>
        </a>
    </div>
</div>

<!-- FlawTrack API Status Section -->
<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-3">
        <a href="/admin/flawtrack" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 clickable-card" id="flawtrack-status-card" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div class="card-body text-white" id="flawtrack-card-body" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-shield-alt me-2" id="flawtrack-icon"></i>
                                <h6 class="mb-0 fw-light">FlawTrack API</h6>
                            </div>
                            <h4 class="mb-1 fw-bold" id="flawtrack-status">Checking...</h4>
                            <small class="opacity-75" id="flawtrack-details">
                                <i class="fas fa-spinner fa-spin me-1"></i>Loading status
                            </small>
                            <div class="mt-2" id="flawtrack-metrics" style="display: none;">
                                <div class="row text-xs">
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold" id="response-time-mini">--</div>
                                            <small class="opacity-75">Response</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold" id="availability-mini">--</div>
                                            <small class="opacity-75">Uptime</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold" id="api-version-mini">--</div>
                                            <small class="opacity-75">Version</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="opacity-20">
                            <i class="fas fa-server fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 text-white-50">
                    <small><i class="fas fa-cog me-1"></i>Click to manage FlawTrack</small>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-bolt text-warning me-2"></i>Quick Actions
                    </h5>
                    <small class="text-muted">Get started with common tasks</small>
                </div>
            </div>
            <div class="card-body pt-3">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <a href="#" onclick="triggerGlobalUpload(); return false;" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center text-decoration-none" style="min-height: 100px;">
                            <div class="mb-2">
                                <i class="fas fa-upload fa-2x text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Upload Contacts</div>
                                <small class="text-muted">Import CSV file</small>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a href="{{ url_for('templates.templates') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center text-decoration-none" style="min-height: 100px;">
                            <div class="mb-2">
                                <i class="fas fa-envelope-open-text fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Manage Templates</div>
                                <small class="text-muted">Edit email content</small>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a href="/breach-checker" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center text-decoration-none" style="min-height: 100px;">
                            <div class="mb-2">
                                <i class="fas fa-search fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Breach Checker</div>
                                <small class="text-muted">Check email/domain breaches</small>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a href="{{ url_for('contacts.index') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center text-decoration-none" style="min-height: 100px;">
                            <div class="mb-2">
                                <i class="fas fa-users fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">View Contacts</div>
                                <small class="text-muted">Manage your list</small>
                            </div>
                        </a>
                    </div>
                </div>
                
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap justify-content-center">
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshStats()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Data
                            </button>
                            <a href="{{ url_for('campaigns.new_campaign') }}" class="btn btn-sm btn-success">
                                <i class="fas fa-rocket me-1"></i>Start New Campaign
                            </a>
                            <a href="{{ url_for('campaigns.index') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-chart-bar me-1"></i>View All Campaigns
                            </a>
                            <a href="/sequence-analytics" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-weight: 600;">
                                <i class="fas fa-chart-line me-1"></i>Sequence Analytics
                            </a>
                            <a href="/test-email" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-paper-plane me-1"></i>Test Email
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Campaigns -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Active Campaigns
                </h5>
            </div>
            <div class="card-body">
                {% if campaigns %}
                    {% for campaign in campaigns %}
                        <div class="campaign-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">
                                    <i class="fas fa-envelope me-1"></i>{{ campaign.name }}
                                </h6>
                                <span class="badge bg-{{ 'success' if campaign.status == 'active' else 'secondary' }}">
                                    {{ campaign.status|title }}
                                </span>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {% if campaign.total_contacts > 0 %}{{ (campaign.sent_count / campaign.total_contacts * 100)|round }}{% else %}0{% endif %}%">
                                            Sent: {{ campaign.sent_count }}/{{ campaign.total_contacts }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        Response Rate: <span style="color: #11998e !important; font-weight: 600;">{{ campaign.response_rate }}%</span>
                                        <span class="ms-2">
                                            <i class="fas fa-calendar me-1"></i>
                                            Created: {{ campaign.created_at.strftime('%m/%d/%Y') if campaign.created_at }}
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-envelope-open fs-1 text-muted mb-3"></i>
                        <p class="text-muted">No campaigns yet. <a href="{{ url_for('campaigns.new_campaign') }}">Create your first campaign</a>.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Hot Prospects Sidebar -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-fire me-2"></i>ðŸ”¥ Hot Prospects
                </h5>
            </div>
            <div class="card-body">
                {% if hot_prospects %}
                    {% for prospect in hot_prospects %}
                        <div class="prospect-item mb-3 p-2 border-start border-danger border-3">
                            <h6 class="mb-1">{{ prospect.email }}</h6>
                            <small class="text-muted">{{ prospect.activity }}</small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-danger me-1">Send Follow-up</button>
                                <button class="btn btn-sm btn-outline-secondary">Add Note</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-thermometer-empty fs-1 text-muted mb-2"></i>
                        <p class="text-muted mb-0">No hot prospects yet.</p>
                        <small class="text-muted">Start a campaign to generate leads!</small>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- System Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-server me-2"></i>System Status
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>FlawTrack API</span>
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Online
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>AWS SES</span>
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Ready
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Database</span>
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Connected
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dashboard
    initializeDashboard();
    
    // Add click animations to metric cards
    document.querySelectorAll('.metric-card').forEach(card => {
        card.addEventListener('click', function() {
            this.classList.add('pulse');
            setTimeout(() => {
                this.classList.remove('pulse');
            }, 600);
        });
    });
    
    // Update last updated time
    updateLastUpdatedTime();
});

function initializeDashboard() {
    // Add fade-in animation to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Add hover effects to action buttons
    document.querySelectorAll('.action-btn, .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-info').forEach(btn => {
        btn.classList.add('action-btn');
    });
}

function refreshStats() {
    const button = event.target;
    const originalHtml = button.innerHTML;
    
    // Add loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    button.disabled = true;
    button.classList.add('shimmer');
    
    // Show loading on metric cards
    const metricCards = document.querySelectorAll('[style*="gradient"]');
    metricCards.forEach(card => {
        card.style.opacity = '0.7';
        card.classList.add('shimmer');
    });
    
    // Fetch updated stats
    fetch('/api/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch stats');
            }
            return response.json();
        })
        .then(data => {
            // Update stats with animation
            updateStatsWithAnimation(data);
            updateLastUpdatedTime();
            
            // Show success feedback
            showNotification('Stats refreshed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error refreshing stats:', error);
            showNotification('Failed to refresh stats', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalHtml;
            button.disabled = false;
            button.classList.remove('shimmer');
            
            // Restore card opacity
            metricCards.forEach(card => {
                card.style.opacity = '1';
                card.classList.remove('shimmer');
            });
        });
}

function updateStatsWithAnimation(data) {
    // Update each stat with a counting animation
    animateNumber('.emails-count', data.emails_this_week || 0);
    animateNumber('.responses-count', data.responses_this_week || 0);
    animateNumber('.contacts-count', data.total_contacts || 0);
    animateNumber('.leads-count', data.hot_leads || 0);
    
    // Update response rate
    const responseRateElement = document.querySelector('.response-rate');
    if (responseRateElement) {
        responseRateElement.textContent = data.response_rate + '%';
    }
}

function animateNumber(selector, targetNumber) {
    const element = document.querySelector(selector);
    if (!element) return;
    
    const currentNumber = parseInt(element.textContent) || 0;
    const increment = Math.ceil((targetNumber - currentNumber) / 20);
    let current = currentNumber;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= targetNumber) || (increment < 0 && current <= targetNumber)) {
            current = targetNumber;
            clearInterval(timer);
        }
        element.textContent = current;
    }, 50);
}

function updateLastUpdatedTime() {
    const lastUpdatedElement = document.getElementById('last-updated');
    if (lastUpdatedElement) {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        lastUpdatedElement.textContent = timeString;
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Auto-refresh stats every 5 minutes
let autoRefreshInterval = setInterval(() => {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            updateStatsWithAnimation(data);
            updateLastUpdatedTime();
            console.log('Stats auto-refreshed:', data);
        })
        .catch(error => console.error('Auto-refresh error:', error));
}, 300000); // 5 minutes

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + R to refresh stats
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        const refreshBtn = document.querySelector('button[onclick="refreshStats()"]');
        if (refreshBtn) {
            refreshBtn.click();
        }
    }
});

// Add tooltips to metric cards
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips if available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // Initialize FlawTrack status monitoring
    initializeFlawTrackStatus();
});

// FlawTrack API Status Functions
function initializeFlawTrackStatus() {
    // Load status on page load
    refreshFlawTrackStatus();

    // Set up periodic status updates (every 5 minutes)
    setInterval(refreshFlawTrackStatus, 5 * 60 * 1000);
}

function refreshFlawTrackStatus() {
    // Show loading state
    updateFlawTrackUI('loading', {
        status: 'Checking...',
        message: 'Loading status',
        response_time_ms: 0,
        api_version: '--'
    });

    fetch('/api/flawtrack/status?refresh=true')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateFlawTrackUI(data.status.healthy ? 'healthy' : 'unhealthy', data.status);
                updateFlawTrackDetails(data.status);

                // Also load availability stats
                loadAvailabilityStats();
            } else {
                updateFlawTrackUI('error', {
                    status: 'Error',
                    message: data.error,
                    response_time_ms: 0,
                    api_version: 'unknown'
                });
            }
        })
        .catch(error => {
            console.error('FlawTrack status check failed:', error);
            updateFlawTrackUI('error', {
                status: 'Connection Failed',
                message: 'Unable to check API status',
                response_time_ms: 0,
                api_version: 'unknown'
            });
        });
}

function updateFlawTrackUI(status, data) {
    const cardBody = document.getElementById('flawtrack-card-body');
    const statusEl = document.getElementById('flawtrack-status');
    const detailsEl = document.getElementById('flawtrack-details');
    const iconEl = document.getElementById('flawtrack-icon');
    const metricsEl = document.getElementById('flawtrack-metrics');

    // Update status text
    statusEl.textContent = data.status;
    detailsEl.innerHTML = `<i class="fas fa-info-circle me-1"></i>${data.message}`;

    // Update styling based on status
    switch (status) {
        case 'healthy':
            cardBody.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            cardBody.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.3)';
            iconEl.className = 'fas fa-check-circle me-2';
            // Show metrics when healthy
            metricsEl.style.display = 'block';
            break;

        case 'unhealthy':
            cardBody.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            cardBody.style.boxShadow = '0 10px 30px rgba(239, 68, 68, 0.3)';
            iconEl.className = 'fas fa-exclamation-triangle me-2';
            metricsEl.style.display = 'none';
            break;

        case 'loading':
            cardBody.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            cardBody.style.boxShadow = '0 10px 30px rgba(107, 114, 128, 0.3)';
            iconEl.className = 'fas fa-spinner fa-spin me-2';
            detailsEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading status';
            metricsEl.style.display = 'none';
            break;

        case 'error':
        default:
            cardBody.style.background = 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)';
            cardBody.style.boxShadow = '0 10px 30px rgba(249, 115, 22, 0.3)';
            iconEl.className = 'fas fa-times-circle me-2';
            metricsEl.style.display = 'none';
            break;
    }
}

function updateFlawTrackDetails(status) {
    // Update mini metrics in the card
    const responseTimeMini = document.getElementById('response-time-mini');
    const apiVersionMini = document.getElementById('api-version-mini');

    responseTimeMini.textContent = status.response_time_ms > 0 ? `${status.response_time_ms}ms` : '--';
    apiVersionMini.textContent = status.api_version || '--';
}

function loadAvailabilityStats() {
    fetch('/api/flawtrack/availability-stats?hours=24')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const availabilityMini = document.getElementById('availability-mini');
                availabilityMini.textContent = `${data.stats.availability_percentage}%`;
            }
        })
        .catch(error => {
            console.error('Failed to load availability stats:', error);
        });
}

function testFlawTrackConnection() {
    const button = document.querySelector('button[onclick="testFlawTrackConnection()"]');
    const originalText = button.innerHTML;

    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    button.disabled = true;

    fetch('/api/flawtrack/test-connection', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const testResult = data.test_result;
                let message = `Health Check: ${testResult.health_check.healthy ? 'PASS' : 'FAIL'}`;

                if (testResult.api_test) {
                    message += `\nAPI Test: ${testResult.api_test.success ? 'PASS' : 'FAIL'}`;
                    if (testResult.api_test.success) {
                        message += `\nResponse Time: ${testResult.api_test.response_time_ms}ms`;
                        message += `\nRecords Found: ${testResult.api_test.record_count}`;
                    }
                }

                alert('FlawTrack Connection Test Results:\n\n' + message);
            } else {
                alert('Connection test failed:\n' + data.error);
            }
        })
        .catch(error => {
            console.error('Connection test failed:', error);
            alert('Connection test failed: ' + error.message);
        })
        .finally(() => {
            // Restore button
            button.innerHTML = originalText;
            button.disabled = false;

            // Refresh status after test
            refreshFlawTrackStatus();
        });
}
</script>
{% endblock %}