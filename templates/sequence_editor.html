{% extends "base.html" %}

{% block title %}{{ 'Edit' if sequence else 'Create' }} Follow-up Sequence - Sales Master{% endblock %}

{% block extra_head %}
<style>
    .sequence-step {
        border-left: 3px solid #007bff;
        transition: all 0.3s ease;
    }
    
    .sequence-step:hover {
        border-left-color: #0056b3;
        background-color: #f8f9fa;
    }
    
    .step-number {
        background-color: #007bff;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .sequence-flow {
        position: relative;
    }
    
    .sequence-arrow {
        color: #6c757d;
        font-size: 1.2rem;
        margin: 0.5rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-{{ 'edit' if sequence else 'plus' }} me-2"></i>
                        {{ 'Edit' if sequence else 'Create' }} Follow-up Sequence
                    </h2>
                    <p class="text-muted mb-0">
                        {{ 'Modify existing sequence' if sequence else 'Create a new automated follow-up sequence' }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('templates.templates') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Editor -->
        <div class="col-lg-8">
            <form method="POST" id="sequence-form">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Sequence Configuration</h5>
                    </div>
                    <div class="card-body">
                        <!-- Basic Info -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="name" class="form-label">Sequence Name *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ sequence.name if sequence else '' }}" required
                                       placeholder="e.g., High-Risk Prospect Follow-up">
                            </div>
                            <div class="col-md-4">
                                <label for="target_industry" class="form-label">Target Industry *</label>
                                <select class="form-select" id="target_industry" name="target_industry" required>
                                    <option value="general" {{ 'selected' if sequence and sequence.target_industry == 'general' else '' }}>üìß General</option>
                                    <option value="technology" {{ 'selected' if sequence and sequence.target_industry == 'technology' else '' }}>üíª Technology</option>
                                    <option value="finance" {{ 'selected' if sequence and sequence.target_industry == 'finance' else '' }}>üí∞ Finance</option>
                                    <option value="healthcare" {{ 'selected' if sequence and sequence.target_industry == 'healthcare' else '' }}>üè• Healthcare</option>
                                    <option value="retail" {{ 'selected' if sequence and sequence.target_industry == 'retail' else '' }}>üõí Retail</option>
                                </select>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Describe the purpose and strategy of this follow-up sequence...">{{ sequence.description if sequence else '' }}</textarea>
                        </div>

                        <!-- Sequence Settings -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="max_follow_ups" class="form-label">Maximum Follow-ups</label>
                                <input type="number" class="form-control" id="max_follow_ups" name="max_follow_ups" 
                                       value="{{ sequence.max_follow_ups if sequence else '5' }}" min="1" max="10" required>
                                <div class="form-text">Maximum number of follow-up emails to send</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stop Conditions</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="stop_on_reply" name="stop_on_reply" 
                                           {{ 'checked' if sequence and sequence.stop_on_reply else 'checked' }}>
                                    <label class="form-check-label" for="stop_on_reply">
                                        Stop on Reply
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="stop_on_bounce" name="stop_on_bounce"
                                           {{ 'checked' if sequence and sequence.stop_on_bounce else 'checked' }}>
                                    <label class="form-check-label" for="stop_on_bounce">
                                        Stop on Bounce
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="created_by" class="form-label">Created By</label>
                                <input type="text" class="form-control" id="created_by" name="created_by" 
                                       value="{{ sequence.created_by if sequence else 'System' }}">
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>{{ 'Update' if sequence else 'Create' }} Sequence
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Sequence Flow Visualization -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sitemap me-2"></i>Sequence Flow Preview</h5>
                </div>
                <div class="card-body">
                    <div class="sequence-flow" id="sequence-flow">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Related Templates -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Related Templates</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Templates that match this sequence's target audience:</p>
                    <div id="related-templates">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading templates...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sequence Statistics -->
            {% if sequence %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fs-4 fw-bold text-primary">{{ sequence.usage_count if sequence else 0 }}</div>
                            <small class="text-muted">Times Used</small>
                        </div>
                        <div class="col-6">
                            <div class="fs-4 fw-bold text-success">{{ sequence.completion_rate if sequence else 0 }}%</div>
                            <small class="text-muted">Completion Rate</small>
                        </div>
                    </div>
                    <hr>
                    <div class="small text-muted">
                        <strong>Created:</strong> {{ sequence.created_at.strftime('%b %d, %Y') if sequence and sequence.created_at else 'Not created yet' }}<br>
                        <strong>Updated:</strong> {{ sequence.updated_at.strftime('%b %d, %Y') if sequence and sequence.updated_at else 'Never updated' }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Best Practices -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Best Practices</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use flexible timing: 15-30 mins for urgent, 2-4 hours for follow-ups, 1-3 days for reminders</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Limit to 3-5 total follow-ups</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Always provide value in each email</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Include clear unsubscribe options</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Personalize based on previous emails</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Stop immediately on reply or opt-out</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const maxFollowUps = document.getElementById('max_follow_ups');
    const riskLevel = document.getElementById('target_industry');
    
    // Update sequence flow visualization
    function updateSequenceFlow() {
        const count = parseInt(maxFollowUps.value) || 5;
        const risk = riskLevel.value;
        
        const flowContainer = document.getElementById('sequence-flow');
        
        // Show loading state
        flowContainer.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-spinner fa-spin me-2"></i>Loading sequence preview...
            </div>
        `;
        
        // Fetch actual templates to get real delay days
        fetch(`/api/templates?target_industry=${risk}`)
            .then(response => response.json())
            .then(templates => {
                // Sort templates by sequence order
                templates.sort((a, b) => a.sequence_order - b.sequence_order);
                
                let flowHTML = '';
                let previousDelay = 0;
                
                templates.forEach((template, index) => {
                    const isFirst = index === 0;
                    
                    // Use flexible delay if available, fallback to legacy delay_days
                    let delayAmount = template.delay_amount || 0;
                    let delayUnit = template.delay_unit || 'days';
                    let legacyDelay = template.delay_days || 0;
                    
                    // If no flexible delay set but legacy delay exists, use it
                    if (delayAmount === 0 && legacyDelay > 0) {
                        delayAmount = legacyDelay;
                        delayUnit = 'days';
                    }
                    
                    // Format delay display
                    let delayDisplay = delayAmount === 0 ? 'Immediate' : `${delayAmount} ${delayUnit}`;
                    if (delayAmount === 1) {
                        delayUnit = delayUnit.slice(0, -1); // Remove 's' for singular
                        delayDisplay = `${delayAmount} ${delayUnit}`;
                    }
                    
                    if (!isFirst && delayAmount > 0) {
                        flowHTML += `
                            <div class="text-center sequence-arrow">
                                <i class="fas fa-arrow-down"></i>
                                <small class="ms-2 text-muted">Wait ${delayDisplay}</small>
                            </div>
                        `;
                    }
                    
                    flowHTML += `
                        <div class="sequence-step p-3 mb-3 border rounded">
                            <div class="d-flex align-items-center">
                                <div class="step-number me-3">${template.sequence_order}</div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${template.template_type === 'initial' ? 'Initial Email' : `Follow-up Email ${template.sequence_order - 1}`}</h6>
                                    <small class="text-muted">${template.name}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-light text-dark small">
                                            ${isFirst ? `Sent after: ${delayDisplay}` : `Delay: ${delayDisplay}`}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (templates.length === 0) {
                    flowHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No templates found for this target audience. Create templates first.
                        </div>
                    `;
                } else {
                    // End condition
                    flowHTML += `
                        <div class="text-center sequence-arrow">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="text-center p-3 border rounded bg-light">
                            <i class="fas fa-flag-checkered text-success me-2"></i>
                            <strong>Sequence Complete</strong>
                        </div>
                    `;
                }
                
                flowContainer.innerHTML = flowHTML;
            })
            .catch(error => {
                console.error('Error loading sequence preview:', error);
                flowContainer.innerHTML = `
                    <div class="text-center text-danger p-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading sequence preview. Please try again.
                    </div>
                `;
            });
    }
    
    // Load related templates
    function loadRelatedTemplates() {
        const risk = riskLevel.value;
        const container = document.getElementById('related-templates');
        
        // Show loading state
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin"></i> Loading templates...
            </div>
        `;
        
        // Fetch templates that match the target industry
        fetch(`/api/templates?target_industry=${risk}`)
            .then(response => response.json())
            .then(templates => {
                let templatesHtml = '';
                
                if (templates.length === 0) {
                    const industryDisplayName = risk === 'technology' ? 'üíª Technology' :
                                               risk === 'finance' ? 'üí∞ Finance' :
                                               risk === 'healthcare' ? 'üè• Healthcare' :
                                               risk === 'retail' ? 'üõí Retail' :
                                               risk === 'general' ? 'üìß General' : risk;

                    templatesHtml = `
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i>
                            No templates found for <strong>${industryDisplayName}</strong>.
                        </div>
                        <div class="d-grid">
                            <a href="/templates/create?target_industry=${risk}&template_type=follow_up" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-plus me-1"></i>Create Template
                            </a>
                        </div>
                    `;
                } else {
                    templatesHtml += `<div class="mb-3"><small class="text-muted">${templates.length} template(s) found:</small></div>`;
                    
                    templates.forEach(template => {
                        const badgeClass = template.template_type === 'initial' ? 'bg-primary' : 'bg-secondary';
                        const statusBadge = template.active ? 
                            '<span class="badge bg-success">Active</span>' : 
                            '<span class="badge bg-secondary">Inactive</span>';
                        
                        // Get industry display with emoji
                        const industryDisplay = template.target_industry === 'technology' ? 'üíª Technology' :
                                               template.target_industry === 'finance' ? 'üí∞ Finance' :
                                               template.target_industry === 'healthcare' ? 'üè• Healthcare' :
                                               template.target_industry === 'retail' ? 'üõí Retail' :
                                               template.target_industry === 'general' ? 'üìß General' :
                                               (template.target_industry || 'General').replace('_', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                        const industryBadgeClass = template.target_industry === 'technology' ? 'bg-primary' :
                                                  template.target_industry === 'finance' ? 'bg-success' :
                                                  template.target_industry === 'healthcare' ? 'bg-danger' :
                                                  template.target_industry === 'retail' ? 'bg-warning' :
                                                  'bg-secondary';
                        
                        templatesHtml += `
                            <div class="border rounded p-2 mb-2 small">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div class="fw-bold">${template.name}</div>
                                    ${statusBadge}
                                </div>
                                <div class="mb-1">
                                    <span class="badge ${badgeClass}">${template.template_type}</span>
                                    <span class="badge ${industryBadgeClass} text-white">${industryDisplay}</span>
                                </div>
                                <div class="text-muted mb-2">${template.subject_line}</div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Order: ${template.sequence_step + 1} | 
                                        Delay: ${(() => {
                                            let delayAmount = template.delay_amount || 0;
                                            let delayUnit = template.delay_unit || 'days';
                                            let legacyDelay = template.delay_days || 0;
                                            
                                            // If no flexible delay set but legacy delay exists, use it
                                            if (delayAmount === 0 && legacyDelay > 0) {
                                                delayAmount = legacyDelay;
                                                delayUnit = 'days';
                                            }
                                            
                                            if (delayAmount === 0) return 'Immediate';
                                            if (delayAmount === 1) {
                                                delayUnit = delayUnit.slice(0, -1); // Remove 's' for singular
                                            }
                                            return `${delayAmount} ${delayUnit}`;
                                        })()}
                                    </small>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/templates/edit/${template.id}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="/templates/preview/${template.id}" 
                                           class="btn btn-outline-info btn-sm" target="_blank">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    templatesHtml += `
                        <div class="d-grid mt-3">
                            <a href="/templates/create?target_industry=${risk}&template_type=follow_up" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-plus me-1"></i>Create New Template
                            </a>
                        </div>
                    `;
                }
                
                container.innerHTML = templatesHtml;
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                container.innerHTML = `
                    <div class="alert alert-danger small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Error loading templates. Please try again.
                    </div>
                `;
            });
    }
    
    // Event listeners
    maxFollowUps.addEventListener('change', updateSequenceFlow);
    riskLevel.addEventListener('change', function() {
        updateSequenceFlow();
        loadRelatedTemplates();
    });
    
    // Initialize
    updateSequenceFlow();
    loadRelatedTemplates();
    
    // Form validation
    document.getElementById('sequence-form').addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const riskLevelVal = riskLevel.value;
        let maxFollowUpsVal = maxFollowUps.value.trim();
        
        if (!name) {
            e.preventDefault();
            alert('Please enter a sequence name');
            return false;
        }
        
        if (!riskLevelVal) {
            e.preventDefault();
            alert('Please select a target audience');
            return false;
        }
        
        // Ensure max_follow_ups has a valid value
        if (!maxFollowUpsVal) {
            maxFollowUps.value = '5';
            maxFollowUpsVal = '5';
        }
        
        const maxFollowUpsNum = parseInt(maxFollowUpsVal);
        if (isNaN(maxFollowUpsNum) || maxFollowUpsNum < 1 || maxFollowUpsNum > 10) {
            e.preventDefault();
            alert('Maximum follow-ups must be a number between 1 and 10');
            return false;
        }
    });
});
</script>
{% endblock %}