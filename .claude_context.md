# Claude AI Context - Sales Master Project

**Last Updated:** October 15, 2025 (Client Template Variables & Clickable Campaign Count Update)
**Project:** Sales Master (Multi-tenant Email Campaign Platform)
**Repository:** https://github.com/AnasElkhodary-69/sales_master.git

---

## ğŸ¯ QUICK START FOR NEW SESSIONS

This is a Flask-based SaaS email campaign management platform that has recently been refactored from a "breach-based" system to an "industry-based" targeting system with multi-tenant client management.

### Recent Major Implementation (Oct 2025)
**Client Management System** - A complete multi-tenant architecture was just implemented. Read `CLIENT_MANAGEMENT_SYSTEM_README.md` for full details.

**LATEST UPDATE (Oct 15, 2025):**
**Multi-Tenant Campaign Integration** - Campaign creation now fully integrated with Client system:
- Campaigns must be associated with a specific client
- Email templates and sequences are now client-specific
- Sender information auto-populates from selected client
- Templates and sequences filter based on selected client
- Migration script created to add client_id to templates and sequences

---

## ğŸ—ï¸ PROJECT ARCHITECTURE

### Technology Stack
- **Backend:** Flask (Python)
- **Database:** SQLite (SQLAlchemy ORM)
- **Frontend:** Bootstrap 5, jQuery, Jinja2 templates
- **Email Provider:** Brevo (formerly SendinBlue)
- **Background Jobs:** APScheduler for auto-enrollment and email processing

### Application Structure
```
Sales Master/
â”œâ”€â”€ app.py                          # Application factory (Flask app creation)
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ database.py                 # All SQLAlchemy models
â”‚   â””â”€â”€ contact.py                  # Contact model helpers
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.py                     # Authentication routes
â”‚   â”œâ”€â”€ dashboard.py                # Main dashboard
â”‚   â”œâ”€â”€ campaigns.py                # Campaign management
â”‚   â”œâ”€â”€ contacts.py                 # Contact management
â”‚   â”œâ”€â”€ clients.py                  # â­ NEW: Client management (multi-tenant)
â”‚   â”œâ”€â”€ templates.py                # Email template management
â”‚   â”œâ”€â”€ sequences.py                # Email sequence management
â”‚   â”œâ”€â”€ analytics.py                # Analytics routes
â”‚   â”œâ”€â”€ tracking.py                 # Email tracking (opens, clicks)
â”‚   â”œâ”€â”€ api.py                      # REST API endpoints
â”‚   â”œâ”€â”€ webhooks.py                 # Webhook handlers (Brevo)
â”‚   â”œâ”€â”€ email_trigger.py            # Manual email trigger
â”‚   â””â”€â”€ enhanced_analytics.py       # Advanced analytics
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auto_enrollment.py          # Auto-enroll contacts into campaigns
â”‚   â”œâ”€â”€ brevo_modern_service.py     # Brevo API integration
â”‚   â”œâ”€â”€ campaign_analytics.py       # Campaign metrics
â”‚   â”œâ”€â”€ email_processor.py          # Email sending queue processor
â”‚   â”œâ”€â”€ email_sequence_service.py   # Sequence management logic
â”‚   â”œâ”€â”€ reply_detection_service.py  # Email reply detection
â”‚   â”œâ”€â”€ scheduler.py                # Background job scheduler
â”‚   â””â”€â”€ template_routes.py          # Template-related service routes
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ base.html                   # Base template (navigation, layout)
â”‚   â”œâ”€â”€ dashboard.html              # Main dashboard
â”‚   â”œâ”€â”€ campaigns/                  # Campaign templates
â”‚   â”œâ”€â”€ contacts/                   # Contact templates
â”‚   â”œâ”€â”€ clients/                    # â­ NEW: Client management templates
â”‚   â”œâ”€â”€ sequences/                  # Sequence editor templates
â”‚   â””â”€â”€ analytics/                  # Analytics templates
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/style.css               # Main stylesheet
â”‚   â””â”€â”€ js/main.js                  # Main JavaScript (includes utilities)
â””â”€â”€ data/
    â””â”€â”€ app.db                      # SQLite database
```

---

## ğŸ—„ï¸ DATABASE MODELS (Critical to Understand)

### Core Models (in `models/database.py`)

1. **Client** (lines 453-520) - â­ NEW
   - Multi-tenant client/customer management
   - Each client has their own sender configuration
   - Tracks email usage quotas
   - Foreign key: campaigns.client_id â†’ clients.id

2. **Campaign**
   - Email campaigns linked to clients
   - Has: name, description, status, target_industry
   - Relationships: contacts (many-to-many), client (many-to-one)

3. **Contact**
   - Target recipients with email, name, company, industry
   - Can belong to multiple campaigns

4. **EmailTemplate** (Updated Oct 15 - Multi-tenant)
   - Reusable email templates
   - Supports Jinja2 variables: {{first_name}}, {{company_name}}, etc.
   - **NEW:** client_id foreign key - templates are now client-specific
   - Has sequence_order field for defining step order in sequences

5. **EmailSequenceConfig** (Updated Oct 15 - Multi-tenant)
   - Configuration for email sequences (target industry, timing rules)
   - **NEW:** client_id foreign key - sequences are now client-specific
   - **IMPORTANT:** Sequence steps are determined by EmailTemplate records (NOT SequenceStep model)
   - Step count = number of EmailTemplate records matching both client_id and target_industry

6. **SequenceStep** (Deprecated/Unused)
   - Originally intended for sequence steps but NOT USED in current system
   - System uses EmailTemplate.sequence_order instead

6. **Email**
   - Individual email records
   - Tracks: sent_at, opened_at, clicked_at, replied_at
   - Links to: campaign, contact, template

7. **WebhookEvent**
   - Stores Brevo webhook events for tracking

### Relationships You Must Know
- Campaign â† many-to-many â†’ Contact (via contact_campaigns join table)
- Campaign â†’ many Emails
- Client â†’ many Campaigns (via client_id FK)
- **Client â†’ many EmailTemplates (via client_id FK)** â­ NEW
- **Client â†’ many EmailSequenceConfigs (via client_id FK)** â­ NEW
- EmailSequenceConfig â†’ many EmailTemplates (via matching client_id + target_industry)
- Contact â†’ many Emails

---

## ğŸš€ CRITICAL IMPLEMENTATION PATTERNS

### 1. Flask Blueprint Registration Pattern
**Location:** `app.py` lines 83-98

ALL blueprints must be:
1. Imported at top of app.py (lines 16-29)
2. Registered in create_app() function (lines 83-98)

```python
from routes.clients import clients_bp
...
app.register_blueprint(clients_bp)  # /clients/*
```

### 2. Template Inheritance
**Base template:** `templates/base.html`

All templates extend base:
```jinja2
{% extends "base.html" %}
{% block title %}Page Title{% endblock %}
{% block content %}
  <!-- Your content -->
{% endblock %}
{% block extra_js %}
  <!-- Page-specific JavaScript -->
{% endblock %}
```

### 3. Modern UI/UX Requirements
**IMPORTANT:** User prefers modern Bootstrap UI, NO old JavaScript alerts!

âœ… **DO:** Use Bootstrap modals for confirmations
âœ… **DO:** Use `SalesMaster.utils.showAlert()` for notifications
âŒ **DON'T:** Use `alert()` or `confirm()` - user explicitly asked to remove these

Example notification:
```javascript
SalesMaster.utils.showAlert('Success message!', 'success'); // green
SalesMaster.utils.showAlert('Error message!', 'danger');    // red
```

### 4. Database Migration Pattern
When adding new models or columns:
1. Modify `models/database.py`
2. Create a migration script (see `migrate_existing_db.py` or `migrate_add_client_to_templates.py` as examples)
3. Run migration on existing databases
4. New installs auto-create via `db.create_all()`

**Recent Migration (Oct 15, 2025):**
`migrate_add_client_to_templates.py` - Added client_id columns to EmailTemplate and EmailSequenceConfig tables
```bash
python migrate_add_client_to_templates.py
```

### 5. Campaign Creation with Client Integration (Oct 15, 2025)
**Location:** `templates/new_campaign.html`, `routes/campaigns.py`

**Multi-step wizard flow:**

**Step 1: Client Selection**
- Client dropdown fetched via AJAX from `/clients/api/list`
- On client selection, JavaScript auto-populates:
  - Sender Email (readonly)
  - Sender Name (readonly)
- JavaScript filters templates and sequences to show only client-specific items
- Implementation: `loadClients()`, `handleClientSelection()` functions (lines 1277-1332)

**Step 2: Target Contacts** (unchanged)
- Industry selection
- Risk level/company filters

**Step 3: Email Sequence**
- Template dropdown filtered by selected client (data-client-id attribute)
- Sequence dropdown filtered by selected client (data-client-id attribute)
- Sequence step count calculated from EmailTemplate records (NOT SequenceStep model)
- Count query: Match EmailTemplate where client_id AND (target_industry OR category) match sequence

**Key JavaScript functions:**
```javascript
loadClients()                    // Fetch clients from API
handleClientSelection(clientId)  // Auto-populate sender info, filter dropdowns
filterTemplatesByClient(clientId) // Show/hide template options
filterSequencesByClient(clientId) // Show/hide sequence options
```

**Important:** Sequences show step count based on actual EmailTemplate records with matching:
- client_id (must match sequence's client_id)
- target_industry or category (must match sequence's target_industry)
- is_active = True

---

## âš ï¸ KNOWN ISSUES & SOLUTIONS

### Issue 1: Flask Template Cache Not Refreshing
**Symptom:** Template changes don't appear even after browser refresh
**Cause:** Flask's Jinja2 template cache doesn't always auto-refresh
**Solution:** Kill all Python processes and restart Flask
```bash
taskkill //F //IM python.exe
python app.py
```

### Issue 2: 404 on Routes After Adding Blueprint
**Symptoms:**
- Route shows in `list_routes.py` but returns 404
- Multiple Flask processes running
**Solution:**
1. Kill ALL Python processes: `taskkill //F //IM python.exe`
2. Clear Python cache: `rm -rf **/__pycache__`
3. Restart Flask once
4. Verify only one Flask process running

### Issue 3: Database Column Doesn't Exist
**Symptom:** "no such column: campaigns.client_id"
**Cause:** Database not migrated after model changes
**Solution:** Run `python migrate_existing_db.py` or `python migrate_add_client_to_templates.py`

### Issue 4: Sequence Showing Wrong Step Count
**Symptom:** Sequence displays "5-step sequence" or "0-step sequence" instead of actual count
**Cause:** Misunderstanding the sequence architecture
**Important:** This system does NOT use SequenceStep model for counting steps!
**Architecture:**
- Sequences are defined by EmailTemplate records
- Each EmailTemplate has a `sequence_order` field (1, 2, 3, etc.)
- Step count = COUNT of EmailTemplate WHERE:
  - client_id matches sequence's client_id
  - (target_industry OR category) matches sequence's target_industry
  - is_active = True
**Solution:** Use the count query in `routes/campaigns.py` lines 294-315

---

## ğŸ”‘ IMPORTANT CODE LOCATIONS

### Authentication
- Admin credentials: Environment variables `ADMIN_USERNAME` and `ADMIN_PASSWORD`
- Default: admin / SalesBreachPro2025!
- Auth routes: `routes/auth.py`

### Navigation Menu
- **File:** `templates/base.html` lines 60-120
- Structure: Dashboard | Campaigns | Contacts | **Clients** â­ | Templates | Analytics
- To add new link: Insert between existing nav items (lines 88-94 for Clients example)

### Email Sending
- **Service:** `services/brevo_modern_service.py`
- Uses Brevo API for transactional emails
- Requires: BREVO_API_KEY in environment

### Background Scheduler
- **File:** `services/scheduler.py`
- Runs every 5 minutes
- Tasks: auto_enrollment, email_processor
- Started in `app.py` lines 142-148

### Jinja2 Variables for Templates
Available in email templates:

**Contact Variables:**
- `{first_name}` - Contact's first name
- `{last_name}` - Contact's last name
- `{company}` - Contact's company name
- `{email}` - Contact's email address
- `{domain}` - Contact's company domain
- `{industry}` - Contact's industry
- `{business_type}` - Contact's business type
- `{company_size}` - Contact's company size

**Client Variables (NEW - Oct 15, 2025):**
- `{client_company_name}` - Client's company name
- `{client_contact_name}` - Client's contact name
- `{client_sender_name}` - Client's sender name
- `{client_sender_email}` - Client's sender email
- `{client_phone}` - Client's phone number
- `{client_website}` - Client's website URL

**Campaign Variables:**
- `{campaign_name}` - Campaign name
- `{tracking_pixel}` - Auto-injected for open tracking

**Important:** Variables use single curly braces `{variable}` not double `{{variable}}`

---

## ğŸ“‹ USER PREFERENCES & CONVENTIONS

### Code Style
- **Naming:** snake_case for Python, camelCase for JavaScript
- **Imports:** Group by: stdlib, third-party, local
- **Docstrings:** Use for all functions (triple quotes)

### Git Commit Messages
User prefers comprehensive commits with:
1. Clear title (50 chars)
2. Detailed description
3. Bullet points for features/changes
4. Footer with: "ğŸ¤– Generated with [Claude Code]" and "Co-Authored-By: Claude <noreply@anthropic.com>"

### UI/UX Preferences
- Bootstrap 5 components
- Modern modals instead of alerts
- Color-coded buttons (success=green, danger=red, warning=yellow)
- Responsive design (mobile-first)
- Icons from Font Awesome
- Stats cards for dashboards

---

## ğŸ¨ BRANDING & NAMING

### Application Name Evolution
1. **Original:** SalesBreachPro (breach-focused)
2. **Current:** Sales Master (industry-focused)
3. **References:** Still some "breach" references in code comments - being gradually cleaned up

### Industry Targeting
The system targets contacts by industry:
- Technology
- Healthcare
- Finance
- Retail
- Manufacturing
- Education
- Real Estate
- Legal
- (Others as defined in Contact.INDUSTRIES)

---

## ğŸ”§ DEVELOPMENT WORKFLOW

### Starting Flask
```bash
cd "C:\Anas's PC\Moaz\Sales Master"
python app.py
# Runs on http://localhost:5001
```

### Testing Routes
```bash
# List all routes
python list_routes.py

# Test route with curl
curl -s "http://localhost:5001/clients/"
```

### Database Inspection
```bash
# SQLite CLI
sqlite3 "data/app.db"
> .tables
> .schema clients
> SELECT * FROM clients;
```

### Debugging Routes
If routes aren't working:
1. Check `app.py` - blueprint imported and registered?
2. Run `list_routes.py` - does route appear?
3. Curl the route - what error?
4. Check Flask logs for errors
5. Kill all Python and restart

---

## ğŸš¦ CURRENT STATUS (As of Oct 15, 2025 - Evening Update)

### âœ… Completed (Multi-tenant Campaign Integration + Client Features)
- [x] Full Client Management System (CRUD)
- [x] Client list page with stats
- [x] Client detail page with campaigns
- [x] Modern Bootstrap modals (no JS alerts)
- [x] Client â†’ Campaign relationship (client_id FK)
- [x] Navigation menu updated
- [x] Database migration script for campaigns
- [x] **Client selector in campaign creation (Step 1)** â­
- [x] **Auto-populate sender info from selected client** â­
- [x] **Client-specific email templates (client_id FK)** â­
- [x] **Client-specific email sequences (client_id FK)** â­
- [x] **Migration script for template/sequence client_id columns** â­
- [x] **JavaScript filtering for templates by client** â­
- [x] **JavaScript filtering for sequences by client** â­
- [x] **Accurate sequence step counting from EmailTemplate records** â­
- [x] **Client contact information fields (contact_name, phone, website)** â­ NEW
- [x] **Database migration for client contact fields** â­ NEW
- [x] **Client template variables ({client_company_name}, {client_phone}, etc.)** â­ NEW
- [x] **Live preview with client data in Email Editor** â­ NEW
- [x] **Test email functionality with client credentials** â­ NEW
- [x] **Clickable campaign count in clients list** â­ NEW
- [x] **Campaign modal showing client's campaigns with stats** â­ NEW
- [x] **API endpoint for client campaigns (/clients/api/<id>/campaigns)** â­ NEW

### ğŸ”„ Pending (Data Management)
- [ ] Assign existing email templates to specific clients (currently client_id = NULL)
- [ ] Assign existing email sequences to specific clients (currently client_id = NULL)
- [ ] Update template management UI to require client selection when creating templates
- [ ] Update sequence management UI to require client selection when creating sequences
- [ ] Test complete campaign creation flow with client-assigned templates/sequences
- [ ] Verify Brevo email sending configuration (test emails not being received)

### ğŸ’¡ Future Enhancements (Not Started)
- Multi-user authentication (currently single admin)
- Client API keys for self-service
- Advanced email analytics (heat maps, device tracking)
- A/B testing for email templates
- Scheduled campaign sends
- Bulk import templates/sequences for clients
- Client-specific usage reports

---

## ğŸ§ª TESTING STRATEGY

### Manual Testing Checklist
When making changes to clients or campaigns:
1. Create a client via UI
2. Edit client details
3. View client detail page
4. Create campaign linked to client
5. Verify sender info populated from client
6. Toggle client status
7. Check campaign still works with inactive client
8. Delete client (should warn about campaigns)

### API Testing
```bash
# Test client API
curl http://localhost:5001/clients/api/list
curl http://localhost:5001/clients/api/1
curl http://localhost:5001/clients/api/stats
```

---

## ğŸ“ COMMON USER REQUESTS

### "Add a new feature to Clients page"
1. Read current Clients implementation: `routes/clients.py`
2. Check templates: `templates/clients/list.html`
3. Follow existing patterns (modals for confirms, Bootstrap alerts)
4. Test thoroughly
5. Commit with descriptive message

### "Fix a bug in campaign creation"
1. Read `routes/campaigns.py`
2. Check form in `templates/new_campaign.html`
3. Test the exact flow user described
4. Fix and verify
5. Update any related documentation

### "Add client selector to campaign form"
âœ… COMPLETED! Implementation:
1. Client dropdown in `templates/new_campaign.html` (lines 253-260)
2. Clients fetched via AJAX from `/clients/api/list`
3. Auto-fill sender fields on client selection (readonly)
4. Client_id stored when creating campaign
5. Templates and sequences filtered by client_id

### "Templates/sequences not showing for my client"
**Common issue:** Existing templates/sequences have client_id = NULL
**Solution:**
1. Assign templates to clients via SQL:
   ```sql
   UPDATE email_templates SET client_id = 1 WHERE id IN (1,2,3,4);
   ```
2. Assign sequences to clients via SQL:
   ```sql
   UPDATE email_sequence_configs SET client_id = 1 WHERE id = 1;
   ```
3. Or create a UI for bulk assignment (future enhancement)

### "Sequence showing 0 steps"
**Cause:** No EmailTemplate records match both client_id AND target_industry
**Fix:** Ensure templates have:
- Correct client_id (matches sequence's client_id)
- Correct target_industry or category (matches sequence's target_industry)
- is_active = True

---

## ğŸ“ KEY LEARNING FROM THIS SESSION

### Template Cache Issue Was Critical
The biggest debugging challenge was template changes not appearing. Remember:
- Browser cache is different from Flask template cache
- Even incognito mode didn't help
- Only restarting Flask cleared it
- Always curl to verify what Flask is actually serving

### Multiple Flask Processes Cause 404s
At one point, 16 Flask processes were running simultaneously!
- This caused route conflicts
- Some routes worked, some didn't
- Solution: Kill all Python processes before starting

### User Hates Old-School Alerts
User explicitly said "there's javascript alert old notification"
- Replaced all `alert()` with Bootstrap alerts
- Replaced all `confirm()` with Bootstrap modals
- Modern UI is a priority

### Email Sequence Architecture Is Template-Based (Oct 15, 2025)
**Critical learning:** The system uses EmailTemplate records to define sequence steps, NOT SequenceStep records!
- User corrected my assumption when I tried to count from SequenceStep table
- User explained: "I already have 4 email templates (1 initial and 3 follow-up) each template have a Sequence order"
- EmailTemplate.sequence_order defines the step number (1, 2, 3, 4)
- EmailTemplate.delay_unit and related fields define timing
- SequenceStep model exists but is NOT used in current implementation
- This is a core architecture pattern - don't try to "fix" it by using SequenceStep!

### Multi-Tenant Architecture Requires Full Isolation (Oct 15, 2025)
**Important decision:** User chose client-specific templates over shared templates
- Original system: Templates shared across all clients
- User's choice: True multi-tenant SaaS with client-specific templates/sequences
- This means: Each client has their own templates, sequences, and branding
- Data isolation: Templates/sequences filtered by client_id throughout the system
- JavaScript filtering: Dropdowns show only items belonging to selected client
- This architectural decision impacts all future template/sequence features

---

## ğŸ“š REFERENCE FILES

**Read these in future sessions:**
- `CLIENT_MANAGEMENT_SYSTEM_README.md` - Client system documentation
- `app.py` - Application factory and blueprint registration
- `models/database.py` - All database models (includes Client, EmailTemplate, EmailSequenceConfig)
- `templates/base.html` - Navigation and layout structure
- `templates/new_campaign.html` - Campaign creation wizard with client integration
- `routes/campaigns.py` - Campaign CRUD with client filtering logic
- `routes/clients.py` - Client management routes and API endpoints
- `static/js/main.js` - Utility functions (showAlert, etc.)
- `migrate_add_client_to_templates.py` - Migration for multi-tenant templates/sequences

**Key Code Sections:**
- Campaign client integration: `templates/new_campaign.html` lines 253-260 (client selector), 1277-1390 (JavaScript)
- Sequence step counting: `routes/campaigns.py` lines 294-315
- Client API: `routes/clients.py` lines 212-228 (api_list_clients)

---

## ğŸ¤– WORKING WITH THIS USER

### Communication Style
- Direct and technical
- Appreciates detailed explanations
- Prefers seeing actual code over descriptions
- Will test immediately and report issues

### Expectations
- Modern, clean UI
- Well-documented code
- Comprehensive git commits
- Solutions that "just work"
- No need to ask permission for obvious improvements

### Workflow
1. User describes what they want
2. I implement it completely
3. User tests it
4. If issues, they report specifically
5. I fix and verify
6. Commit to git when approved

---

## ğŸ¯ NEXT TIME YOU (CLAUDE) READ THIS

1. **Skim this entire document first** (5 min read)
2. **Check git log** to see what's changed since Oct 15, 2025
3. **Read the TODO list** for pending tasks
4. **Ask user what they want to work on**
5. **Reference this doc** for patterns and conventions

**Remember:** This user values efficiency. Don't re-explain things documented here. Jump straight to implementation using the patterns defined above.

---

---

## ğŸ“ SESSION NOTES: October 15, 2025 (Evening Session)

### What Was Implemented

**1. Client Contact Information Fields**
- Added `contact_name`, `phone`, `website` columns to Client model
- Created database migration script: `add_client_contact_fields.py`
- Updated client create/edit forms to include new fields
- All fields stored in `data/app.db`

**2. Client Template Variables**
- Added 6 new template variables for client-specific branding:
  - `{client_company_name}` - Company name from Client model
  - `{client_contact_name}` - Contact person name
  - `{client_sender_name}` - Email sender display name
  - `{client_sender_email}` - Email sender address
  - `{client_phone}` - Client phone number
  - `{client_website}` - Client website URL
- Variables work in both Template Editor and Email Editor
- Live preview shows real client data (not hardcoded samples)
- Variables auto-populate in test emails

**3. Clickable Campaign Count Feature**
- Made campaign count badge clickable in clients list (`templates/clients/list.html:132-136`)
- Clicking opens Bootstrap modal with campaign details
- Modal shows: campaign name, status, contacts, emails sent, responses
- Each campaign name links to full campaign view
- API endpoint created: `GET /clients/api/<client_id>/campaigns`
- JavaScript function: `showClientCampaigns(clientId)`

**4. Bug Fixes**
- Fixed campaign modal URL from `/campaigns/view/1` to `/campaigns/1` (proper route format)
- Fixed API Response query - Response model linked to Email, not Campaign directly
- Fixed multiple Flask instances issue (user had 20+ processes running)
- Browser cache issue resolved by restarting Flask

### Key Code Changes

**Files Modified:**
1. `models/database.py` - Client model (lines 469-471, 507-509)
2. `add_client_contact_fields.py` - NEW migration script
3. `templates/clients/create.html` - Added contact fields (lines 42-58)
4. `templates/clients/edit.html` - Added contact fields
5. `templates/clients/list.html` - Campaign count modal (lines 131-136, 193-217, 321-414)
6. `routes/clients.py` - API endpoint (lines 285-337)
7. `routes/templates.py` - Test data with client variables (lines 395-401)
8. `services/email_processor.py` - Client variable substitution (lines 397-407)

**Critical Bug Fix in `routes/clients.py`:**
```python
# BEFORE (WRONG):
responses = Response.query.filter_by(campaign_id=campaign.id).count()

# AFTER (CORRECT):
responses = db.session.query(Response).join(
    Email, Response.email_id == Email.id
).filter(Email.campaign_id == campaign.id).count()
```

### Known Issues

**Brevo Email Sending:**
- Test emails show "sent successfully" in logs
- Brevo API returns message IDs
- However, emails not being received
- Brevo account not deducting credits
- **Root Cause:** Likely Brevo account configuration issue:
  - API key may be from inactive/trial/sandbox account
  - Sender email not verified in Brevo
  - Account in sandbox mode
- **Resolution:** User needs to check Brevo dashboard for account status and sender verification

### Important Architectural Notes

1. **Client Data in Templates:**
   - Templates now pull real client data via `client_id`
   - Live preview fetches client from database (not hardcoded)
   - Test emails use client's Brevo API key if available

2. **Response Counting:**
   - Response model has `email_id`, NOT `campaign_id`
   - Must join through Email model to count responses per campaign
   - This pattern applies everywhere responses are counted

3. **Multiple Flask Instances:**
   - User's environment prone to multiple Flask processes
   - Always recommend: `taskkill //F //IM python.exe` before restart
   - Caused routes to work intermittently (old vs new code)

---

**End of Claude Context File**
*This file is for AI assistants. For human documentation, see CLIENT_MANAGEMENT_SYSTEM_README.md*
